---
- name: Create summary index
  copy:
    content: |
      # AI Code Review Results

      **Job**: {{ zuul.job }}
      **Project**: {{ zuul.project.name }}
      **Change**: {{ zuul.change }} (Patchset {{ zuul.patchset }})
      **Branch**: {{ zuul.branch }}
      **Review Date**: {{ ansible_date_time.iso8601 }}

      ## Models Used
      - **Context Extraction**: {{ context_model }}
      - **Code Review**: {{ review_model }}

      ## Generated Reports
      1. [Zuul Context](zuul-context.md) - Execution environment details
      2. [Commit Summary](commit-summary.md) - Change metadata and overview
      3. [Review Report](review-report.md) - Comprehensive code review (Markdown)
      4. [Review Report (HTML)](review-report.html) - Comprehensive code review (HTML)

      ## Quick Summary
      - **Issues Found**: {{ issue_count | default(0) }}
      - **Review Status**: {{ 'NEEDS ATTENTION' if has_issues else 'PASSED' }}

      ---
      *Generated by TEIM Code Review (Claude Code via LiteLLM)*
    dest: "{{ review_output_dir }}/index.md"
    mode: '0644'

- name: Create virtual environment for HTML generation
  command: python3 -m venv {{ ansible_user_dir }}/.venv-html-gen
  args:
    creates: "{{ ansible_user_dir }}/.venv-html-gen"

- name: Install mistune in virtual environment
  command: >
    {{ ansible_user_dir }}/.venv-html-gen/bin/pip install mistune
  args:
    creates: "{{ ansible_user_dir }}/.venv-html-gen/lib/python*/site-packages/mistune"

- name: Copy HTML generator script
  copy:
    src: files/generate_html_report.py
    dest: "{{ ansible_user_dir }}/generate_html_report.py"
    mode: '0755'

- name: Generate HTML report from markdown
  command: >
    {{ ansible_user_dir }}/.venv-html-gen/bin/python3
    {{ ansible_user_dir }}/generate_html_report.py
    {{ review_output_dir }}/review-report.md
    {{ review_output_dir }}/review-report.html
  register: html_generation
  ignore_errors: yes

- name: Display HTML generation result
  debug:
    msg: "{{ html_generation.stdout if html_generation.rc == 0 else 'HTML generation failed: ' + html_generation.stderr }}"
  when: html_generation is defined

- name: List all generated files
  find:
    paths: "{{ review_output_dir }}"
    patterns: "*.md,*.html,*.json"
  register: review_files

- name: Display generated files
  debug:
    msg: "Generated {{ review_files.matched }} review files in {{ review_output_dir }}"

- name: Check for zuul return data file
  stat:
    path: "{{ review_output_dir }}/zuul-return-data.json"
  register: zuul_return_file

- name: Load and display zuul return data
  include_tasks: tasks/display-zuul-return.yaml
  when: zuul_return_file.stat.exists

- name: Create timestamped archive
  archive:
    path: "{{ review_output_dir }}/"
    dest: "{{ ansible_user_dir }}/logs/code-review-{{ zuul.change }}-{{ zuul.patchset }}.tar.gz"
    format: gz
  when: review_files.matched > 0
