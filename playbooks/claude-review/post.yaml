---
- hosts: all
  tasks:
    - name: Copy review parser scripts to working directory
      copy:
        src: "{{ item }}"
        dest: "{{ ansible_user_dir }}/"
        mode: '0755'
      loop:
        - files/parse_review_for_comments.py
        - files/validate_zuul_schema.py

    - name: Check if review report exists
      stat:
        path: "{{ review_output_dir }}/review-report.md"
      register: review_report_exists

    - name: Check if parser script exists
      stat:
        path: "{{ ansible_user_dir }}/parse_review_for_comments.py"
      register: parser_script_exists

    - name: Fail if review report not found
      fail:
        msg: "Review report not found at {{ review_output_dir }}/review-report.md"
      when: not review_report_exists.stat.exists

    - name: Fail if parser script not found
      fail:
        msg: "Parser script not found at {{ ansible_user_dir }}/parse_review_for_comments.py"
      when: not parser_script_exists.stat.exists

    - name: Parse review report for inline comments
      command: >
        {{ ansible_user_dir }}/.venv-html-gen/bin/python3
        {{ ansible_user_dir }}/parse_review_for_comments.py
        {{ review_output_dir }}/review-report.md
        -o {{ review_output_dir }}/zuul-return-data.json
        --summary
      register: review_comments
      failed_when: review_comments.rc != 0
      changed_when: false

    - name: Validate JSON schema
      command: >
        {{ ansible_user_dir }}/.venv-html-gen/bin/python3
        {{ ansible_user_dir }}/validate_zuul_schema.py
        {{ review_output_dir }}/zuul-return-data.json
      register: json_validation
      changed_when: false
      when: review_comments.rc == 0

    - name: Read generated JSON from remote host
      slurp:
        src: "{{ review_output_dir }}/zuul-return-data.json"
      register: json_file_content
      when: json_validation.rc == 0

    - name: Load comments data for zuul_return
      set_fact:
        zuul_return_data: "{{ json_file_content.content | b64decode | from_json }}"
      when:
        - json_file_content is defined
        - json_validation.rc == 0

    - name: Return file comments to Zuul
      zuul_return:
        data: "{{ zuul_return_data }}"
      when: zuul_return_data is defined and zuul_return_data.zuul.file_comments | length > 0

    - name: Display comment summary
      debug:
        msg: "{{ review_comments.stderr_lines[-2:] }}"
      when: review_comments.stderr_lines is defined and review_comments.stderr_lines | length > 0

    - name: Stage output from all nodes
      include_role:
        name: stage-output
