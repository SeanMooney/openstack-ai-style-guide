---
- name: Create summary index
  copy:
    content: |
      # AI Code Review Results
      
      **Job**: {{ zuul.job }}
      **Project**: {{ zuul.project.name }}
      **Change**: {{ zuul.change }} (Patchset {{ zuul.patchset }})
      **Branch**: {{ zuul.branch }}
      **Review Date**: {{ ansible_date_time.iso8601 }}
      
      ## Models Used
      - **Context Extraction**: {{ context_model }}
      - **Code Review**: {{ review_model }}
      
      ## Generated Reports
      1. [Zuul Context](zuul-context.md) - Execution environment details
      2. [Commit Summary](commit-summary.md) - Change metadata and overview
      3. [Review Report](review-report.md) - Comprehensive code review
      
      ## Quick Summary
      - **Issues Found**: {{ issue_count | default(0) }}
      - **Review Status**: {{ 'NEEDS ATTENTION' if has_issues else 'PASSED' }}
      
      ---
      *Generated by OpenStack AI Code Review (OpenCode + LiteLLM)*
    dest: "{{ review_output_dir }}/index.md"
    mode: '0644'

- name: List all generated files
  find:
    paths: "{{ review_output_dir }}"
    patterns: "*.md"
  register: review_files

- name: Display generated files
  debug:
    msg: "Generated {{ review_files.matched }} review files in {{ review_output_dir }}"

- name: Create timestamped archive
  archive:
    path: "{{ review_output_dir }}/"
    dest: "{{ ansible_user_dir }}/logs/code-review-{{ zuul.change }}-{{ zuul.patchset }}.tar.gz"
    format: gz
  when: review_files.matched > 0
