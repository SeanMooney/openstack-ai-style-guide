---
# AI-Assisted Code Review Playbook (Task-Based Orchestration)
#
# This playbook performs comprehensive AI-assisted code review using modular
# Ansible roles with explicit task-based orchestration. Each role is included
# in a specific order to ensure proper execution:
#
# 1. ai_review_setup (foundation - sets up Claude CLI)
# 2. ai_context_extraction (extracts Zuul context and git commits)
# 3. ai_code_review (performs AI code review)
# 4. ai_html_generation (generates HTML report)
# 5. ai_zuul_integration (generates Zuul comments and registers artifacts)
#
# Required variables (set in job definition):
#   - claude_binary: Path to Claude CLI executable
#   - claude_config_dir: Claude CLI configuration directory
#   - haiku_model, sonnet_model, opus_model: Model names
#   - context_model: Model for context extraction (fast)
#   - review_model: Model for code review (most capable)
#   - style_guide_project: Path to style guide repository
#   - anthropic_auth_token: API authentication token
#   - anthropic_api_url: API base URL

- hosts: all
  name: AI-Assisted Code Review
  tasks:
    - name: Run AI review setup
      include_role:
        name: ai_review_setup
      vars:
        ai_review_setup_claude_binary: "{{ claude_binary }}"
        ai_review_setup_claude_config_dir: "{{ claude_config_dir }}"
        ai_review_setup_agents_source_dir: "{{ agents_source_dir }}"
        ai_review_setup_agents_target_dir: "{{ agents_target_dir }}"
        ai_review_setup_haiku_model: "{{ haiku_model }}"
        ai_review_setup_sonnet_model: "{{ sonnet_model }}"
        ai_review_setup_opus_model: "{{ opus_model }}"
        ai_review_setup_review_output_dir: "{{ review_output_dir }}"
        ai_review_setup_style_guide_project: "{{ style_guide_project }}"

    - name: Extract context from Zuul and git
      include_role:
        name: ai_context_extraction

    - name: Perform AI code review
      include_role:
        name: ai_code_review

    - name: Generate HTML report
      include_role:
        name: ai_html_generation

    - name: Integrate with Zuul (comments and artifacts)
      include_role:
        name: ai_zuul_integration

  post_tasks:
    - name: Display job summary
      debug:
        msg: |
          ================================================================================
          AI Code Review Complete
          ================================================================================
          Review Report (JSON): {{ review_output_dir }}/review-report.json
          HTML Report: {{ review_output_dir }}/review-report.html
          Zuul Comments: {{ review_output_dir }}/zuul-comments.json

          Issue Statistics:
          {{ issue_statistics.stdout | default('Not available') }}

          Status: {{ 'NEEDS ATTENTION' if has_critical_issues | default(false) else ('HAS SUGGESTIONS' if has_issues | default(false) else 'CLEAN') }}
          ================================================================================
