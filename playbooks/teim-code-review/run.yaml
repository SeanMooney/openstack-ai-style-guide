---
# AI-Assisted Code Review Playbook (Task-Based Orchestration)
#
# This playbook performs comprehensive AI-assisted code review using modular
# Ansible roles with explicit task-based orchestration. Each role is included
# in a specific order to ensure proper execution:
#
# 1. ai-review-setup (foundation - sets up Claude CLI)
# 2. ai-context-extraction (extracts Zuul context and git commits)
# 3. ai-code-review (performs AI code review)
# 4. ai-html-generation (generates HTML report)
# 5. ai-zuul-integration (generates Zuul comments and registers artifacts)
#
# Required variables (set in job definition):
#   - claude_binary: Path to Claude CLI executable
#   - claude_config_dir: Claude CLI configuration directory
#   - haiku_model, sonnet_model, opus_model: Model names
#   - context_model: Model for context extraction (fast)
#   - review_model: Model for code review (most capable)
#   - style_guide_project: Path to style guide repository
#   - anthropic_auth_token: API authentication token
#   - anthropic_api_url: API base URL

- hosts: all
  name: AI-Assisted Code Review
  tasks:
    - name: Run AI review setup
      include_role:
        name: ai-review-setup

    - name: Extract context from Zuul and git
      include_role:
        name: ai-context-extraction

    - name: Perform AI code review
      include_role:
        name: ai-code-review

    - name: Generate HTML report
      include_role:
        name: ai-html-generation

    - name: Integrate with Zuul (comments and artifacts)
      include_role:
        name: ai-zuul-integration

  post_tasks:
    - name: Display job summary
      debug:
        msg: |
          ================================================================================
          AI Code Review Complete
          ================================================================================
          Review Report (JSON): {{ review_output_dir }}/review-report.json
          HTML Report: {{ review_output_dir }}/review-report.html
          Zuul Comments: {{ review_output_dir }}/zuul-comments.json

          Issue Statistics:
          {{ issue_statistics.stdout | default('Not available') }}

          Status: {{ 'NEEDS ATTENTION' if has_critical_issues | default(false) else ('HAS SUGGESTIONS' if has_issues | default(false) else 'CLEAN') }}
          ================================================================================
