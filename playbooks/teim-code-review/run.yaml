---
# AI-Assisted Code Review Playbook (Task-Based Orchestration)
#
# This playbook performs comprehensive AI-assisted code review using modular
# Ansible roles with explicit task-based orchestration. Each role is included
# in a specific order to ensure proper execution:
#
# 1. ai_review_setup (foundation - sets up Claude CLI)
# 2. ai_context_extraction (extracts Zuul context and git commits)
# 3. ai_code_review (performs AI code review)
# 4. ai_html_generation (generates HTML report)
# 5. ai_zuul_integration (generates Zuul comments and registers artifacts)
#
# Required variables (set in job definition):
#   - claude_binary: Path to Claude CLI executable
#   - claude_config_dir: Claude CLI configuration directory
#   - haiku_model, sonnet_model, opus_model: Model names
#   - context_model: Model for context extraction (fast)
#   - review_model: Model for code review (most capable)
#   - style_guide_project: Path to style guide repository
#   - anthropic_auth_token: API authentication token
#   - anthropic_api_url: API base URL

- name: AI-Assisted Code Review
  hosts: all
  tasks:
    - name: Run AI review setup
      ansible.builtin.include_role:
        name: ai_review_setup
      vars:
        ai_review_setup_claude_binary: "{{ claude_binary }}"
        ai_review_setup_claude_config_dir: "{{ claude_config_dir }}"
        ai_review_setup_agents_source_dir: "{{ agents_source_dir }}"
        ai_review_setup_agents_target_dir: "{{ agents_target_dir }}"
        ai_review_setup_haiku_model: "{{ haiku_model }}"
        ai_review_setup_sonnet_model: "{{ sonnet_model }}"
        ai_review_setup_opus_model: "{{ opus_model }}"
        ai_review_setup_review_output_dir: "{{ review_output_dir }}"
        ai_review_setup_style_guide_project: "{{ style_guide_project }}"

    - name: Extract context from Zuul and git
      ansible.builtin.include_role:
        name: ai_context_extraction
      vars:
        ai_context_extraction_model: "{{ context_model }}"
        ai_context_extraction_output_file: "{{ context_output_file }}"
        ai_context_extraction_commit_summary_file: "{{ commit_summary_file }}"
        ai_context_extraction_commit_context_file: "{{ commit_context_file }}"
        ai_context_extraction_review_output_dir: "{{ review_output_dir }}"
        ai_context_extraction_claude_binary: "{{ claude_binary }}"
        ai_context_extraction_anthropic_auth_token: "{{ anthropic_auth_token }}"
        ai_context_extraction_anthropic_api_url: "{{ anthropic_api_url }}"

    - name: Perform AI code review
      ansible.builtin.include_role:
        name: ai_code_review
      vars:
        ai_code_review_model: "{{ review_model }}"
        ai_code_review_context_output_file: "{{ context_output_file }}"
        ai_code_review_commit_summary_file: "{{ commit_summary_file }}"
        ai_code_review_style_guide_project: "{{ style_guide_project }}"
        ai_code_review_style_guide_quick_rules: "{{ style_guide_quick_rules }}"
        ai_code_review_style_guide_comprehensive: "{{ style_guide_comprehensive }}"
        ai_code_review_report_file: "{{ review_report_file }}"
        ai_code_review_output_dir: "{{ review_output_dir }}"
        ai_code_review_project_src_dir: "{{ ansible_user_dir }}/{{ zuul.project.src_dir }}"

    - name: Generate HTML report
      ansible.builtin.include_role:
        name: ai_html_generation
      vars:
        ai_html_generation_venv_dir: "{{ venv_dir }}"
        ai_html_generation_review_report_file: "{{ review_report_file }}"
        ai_html_generation_html_report_file: "{{ html_report_file }}"
        ai_html_generation_review_output_dir: "{{ review_output_dir }}"

    - name: Integrate with Zuul (comments and artifacts)
      ansible.builtin.include_role:
        name: ai_zuul_integration
      vars:
        ai_zuul_integration_venv_dir: "{{ venv_dir }}"
        ai_zuul_integration_review_report_file: "{{ review_report_file }}"
        ai_zuul_integration_html_report_file: "{{ html_report_file }}"
        ai_zuul_integration_zuul_comments_file: "{{ zuul_comments_file }}"
        ai_zuul_integration_review_output_dir: "{{ review_output_dir }}"

  post_tasks:
    - name: Display job summary
      ansible.builtin.debug:
        msg: |
          ================================================================
          AI Code Review Complete
          ================================================================
          Review Report (JSON): {{ review_output_dir }}/review-report.json
          HTML Report: {{ review_output_dir }}/review-report.html
          Zuul Comments: {{ review_output_dir }}/zuul-comments.json

          Issue Statistics:
          {{ ai_code_review_issue_statistics.stdout | default('N/A') }}

          {% if ai_code_review_has_critical_issues | default(false) %}
          Status: NEEDS ATTENTION
          {% elif ai_code_review_has_issues | default(false) %}
          Status: HAS SUGGESTIONS
          {% else %}
          Status: CLEAN
          {% endif %}
          ================================================================
