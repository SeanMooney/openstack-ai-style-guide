---
# AI Code Review Role
# Performs comprehensive code review using AI agent with structured output

- name: Verify prerequisite context files exist
  ansible.builtin.stat:
    path: "{{ item }}"
  register: ai_code_review_prereq_files
  loop:
    - "{{ ai_code_review_context_output_file }}"
    - "{{ ai_code_review_commit_summary_file }}"
    - "{{ ai_code_review_style_guide_quick_rules }}"
    - "{{ ai_code_review_style_guide_comprehensive }}"
    - "{{ ai_code_review_json_schema }}"

- name: Fail if prerequisite files missing
  ansible.builtin.fail:
    msg: "Missing prerequisite file: {{ item.item }}"
  when: not item.stat.exists
  loop: "{{ ai_code_review_prereq_files.results }}"

- name: Create code review prompt with @file references and subagent invocation
  ansible.builtin.set_fact:
    ai_code_review_review_prompt: >-
      Use the @agent-code-review-agent subagent to
      perform a comprehensive code review of the change.

      Read @{{ ai_code_review_context_output_file }} for Zuul execution context.
      Read @{{ ai_code_review_commit_summary_file }} for commit metadata and change summary.
      Read @{{ ai_code_review_style_guide_quick_rules }} for essential OpenStack coding standards and rules.
      Read @{{ ai_code_review_style_guide_comprehensive }} for detailed explanations and complex scenarios.

      The project under review is located at: {{ ai_code_review_project_src_dir }}

      Generate a structured JSON review report conforming to the review-report-schema.json
      with severity-categorized findings (critical, high, warnings, suggestions).
      The output will be validated against the JSON schema automatically.

- name: Execute code review with Claude (structured output)
  ansible.builtin.include_role:
    name: run_claude_code
  vars:
    run_claude_code_prompt_text: "{{ ai_code_review_review_prompt }}"
    run_claude_code_model_name: "{{ ai_code_review_model }}"
    run_claude_code_output_file: "{{ ai_code_review_report_file }}"
    run_claude_code_json_schema: "{{ ai_code_review_json_schema }}"
    run_claude_code_output_format: "json"
    run_claude_code_command_name: "code review"
    run_claude_code_working_dir: "{{ ai_code_review_project_src_dir }}"
    run_claude_code_claude_binary: "{{ ai_code_review_claude_binary }}"
    run_claude_code_anthropic_auth_token: "{{ ai_code_review_anthropic_auth_token }}"
    run_claude_code_anthropic_api_url: "{{ ai_code_review_anthropic_api_url }}"

# Claude CLI validates the structured_output against the schema automatically.
# The downstream Python scripts (HTML generation, Zuul comments) handle
# extracting the structured_output from the Claude CLI wrapper.
