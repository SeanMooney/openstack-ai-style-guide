---
# Analyze git commit metadata and changes

- name: Get project source directory
  set_fact:
    project_src_dir: "{{ ansible_user_dir }}/{{ zuul.project.src_dir }}"

- name: Verify project source directory exists
  stat:
    path: "{{ project_src_dir }}"
  register: project_dir

- name: Fail if project directory not found
  fail:
    msg: "Project source directory not found at {{ project_src_dir }}"
  when: not project_dir.stat.exists

- name: Generate git context file
  shell:
    cmd: |
      set -e
      {
        echo "# Commit Metadata";
        git log -1 --pretty=fuller || true;
        echo;
        echo "# Changed Files";
        git diff --name-status HEAD~1..HEAD || git diff --name-status || true;
        echo;
        echo "# Diff (unified)";
        git diff -U0 --no-color HEAD~1..HEAD || true;
      } > "{{ ai_context_extraction_commit_context_file }}"
    chdir: "{{ project_src_dir }}"
  changed_when: true

- name: Create commit analysis prompt with subagent invocation
  set_fact:
    commit_prompt: >-
      Use the @agent-commit-summary subagent to
      Analyze the current git commit in the repository at {{ project_src_dir }}.
      Extract commit metadata, generate an ASCII file tree relative to
      {{ project_src_dir }}, identify bug/feature markers
      following OpenStack conventions, and summarize what changed and why.
      Follow commit-summarizer agent instructions.
      Write a structured commit summary to {{ ai_context_extraction_commit_summary_file }}.
      Do not output the report in {{ project_src_dir }}.
      Prefer using absolute paths when creating files to ensure they are created
      at the expected location.
      You MUST verify that the summary was created at
      {{ ai_context_extraction_commit_summary_file }} before completing this task.
      If the structured commit summary was output to a different location move it
      to {{ ai_context_extraction_commit_summary_file }}

- name: Execute commit analysis with Claude
  include_tasks: "../../ai_review_setup/tasks/run-claude-command.yaml"
  vars:
    prompt_text: "{{ commit_prompt }}"
    model_name: "{{ ai_context_extraction_model }}"
    output_file: "{{ ai_context_extraction_commit_summary_file }}"
    command_name: "commit analysis"
    working_dir: "{{ project_src_dir }}"
