---
# Extract Zuul execution context from inventory

- name: Create temporary directory for inventory
  file:
    path: "{{ ansible_user_dir }}/tmp"
    state: directory
    mode: '0755'

- name: Copy inventory from executor to remote node
  copy:
    src: "{{ zuul.executor.inventory_file }}"
    dest: "{{ ansible_user_dir }}/tmp/inventory.yaml"
    mode: '0644'

- name: Verify inventory file was copied
  stat:
    path: "{{ ansible_user_dir }}/tmp/inventory.yaml"
  register: inventory_file

- name: Fail if inventory copy failed
  fail:
    msg: "Could not copy Zuul inventory file from executor"
  when: not inventory_file.stat.exists

- name: Set inventory path
  set_fact:
    zuul_inventory_path: "{{ ansible_user_dir }}/tmp/inventory.yaml"

- name: Create context extraction prompt with subagent invocation
  set_fact:
    context_prompt: >-
      Use the @agent-zuul-context-extractor subagent.
      Read and analyze the Zuul inventory at @{{ zuul_inventory_path }}.
      Write the structured context summary to {{ ai_context_extraction_output_file }}.

- name: Execute context extraction with Claude
  include_tasks: "../../ai_review_setup/tasks/run-claude-command.yaml"
  vars:
    prompt_text: "{{ context_prompt }}"
    model_name: "{{ ai_context_extraction_model }}"
    output_file: "{{ ai_context_extraction_output_file }}"
    command_name: "context extraction"
