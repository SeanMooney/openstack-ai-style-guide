---
# Extract Zuul execution context from inventory

- name: Create temporary directory for inventory
  file:
    path: "{{ ansible_user_dir }}/tmp"
    state: directory
    mode: '0755'

- name: Copy inventory from executor to remote node
  copy:
    src: "{{ zuul.executor.inventory_file }}"
    dest: "{{ ansible_user_dir }}/tmp/inventory.yaml"
    mode: '0644'

- name: Verify inventory file was copied
  stat:
    path: "{{ ansible_user_dir }}/tmp/inventory.yaml"
  register: ai_context_extraction_inventory_file

- name: Fail if inventory copy failed
  fail:
    msg: "Could not copy Zuul inventory file from executor"
  when: not ai_context_extraction_inventory_file.stat.exists

- name: Set inventory path
  set_fact:
    ai_context_extraction_zuul_inventory_path: "{{ ansible_user_dir }}/tmp/inventory.yaml"

- name: Create context extraction prompt with subagent invocation
  set_fact:
    ai_context_extraction_context_prompt: >-
      Use the @agent-zuul-context-extractor subagent.
      Read and analyze the Zuul inventory at @{{ ai_context_extraction_zuul_inventory_path }}.
      Write the structured context summary to {{ ai_context_extraction_output_file }}.

- name: Execute context extraction with Claude
  ansible.builtin.include_role:
    name: run_claude_code
  vars:
    run_claude_code_prompt_text: "{{ ai_context_extraction_context_prompt }}"
    run_claude_code_model_name: "{{ ai_context_extraction_model }}"
    run_claude_code_output_file: "{{ ai_context_extraction_output_file }}"
    run_claude_code_command_name: "context extraction"
    run_claude_code_claude_binary: "{{ ai_context_extraction_claude_binary }}"
    run_claude_code_anthropic_auth_token: "{{ ai_context_extraction_anthropic_auth_token }}"
    run_claude_code_anthropic_api_url: "{{ ai_context_extraction_anthropic_api_url }}"
