---
# AI HTML Generation Role
# Generates enhanced HTML reports from JSON review data

- name: Create virtual environment for HTML generation
  ansible.builtin.command: python3 -m venv {{ ai_html_generation_venv_dir }}
  args:
    creates: "{{ ai_html_generation_venv_dir }}"

- name: Copy HTML renderer script
  ansible.builtin.copy:
    src: render_html_from_json.py
    dest: "{{ ansible_user_dir }}/render_html_from_json.py"
    mode: '0755'

- name: Check if JSON review report exists
  ansible.builtin.stat:
    path: "{{ ai_html_generation_review_report_file }}"
  register: ai_html_generation_json_report

- name: Fail if JSON report not found
  ansible.builtin.fail:
    msg: "JSON review report not found at {{ ai_html_generation_review_report_file }}"
  when: not ai_html_generation_json_report.stat.exists

- name: Generate HTML report from JSON
  ansible.builtin.command: >
    {{ ai_html_generation_venv_dir }}/bin/python3
    {{ ansible_user_dir }}/render_html_from_json.py
    {{ ai_html_generation_review_report_file }}
    {{ ai_html_generation_html_report_file }}
    -v
  register: ai_html_generation_html_generation
  changed_when: ai_html_generation_html_generation.rc == 0

- name: Display HTML generation result
  ansible.builtin.debug:
    msg: "{{ ai_html_generation_html_generation.stdout }}"
  when: ai_html_generation_html_generation.rc == 0

- name: Display HTML generation error
  ansible.builtin.debug:
    msg: "HTML generation failed: {{ ai_html_generation_html_generation.stderr }}"
  when: ai_html_generation_html_generation.rc != 0

- name: Verify HTML report was created
  ansible.builtin.stat:
    path: "{{ ai_html_generation_html_report_file }}"
  register: ai_html_generation_html_report

- name: Fail if HTML generation failed
  ansible.builtin.fail:
    msg: "HTML report generation failed"
  when: not ai_html_generation_html_report.stat.exists
