---
# AI HTML Generation Role
# Generates enhanced HTML reports from JSON review data

- name: Create virtual environment for HTML generation
  command: python3 -m venv {{ ai_html_generation_venv_dir }}
  args:
    creates: "{{ ai_html_generation_venv_dir }}"

- name: Copy HTML renderer script
  copy:
    src: render_html_from_json.py
    dest: "{{ ansible_user_dir }}/render_html_from_json.py"
    mode: '0755'

- name: Check if JSON review report exists
  stat:
    path: "{{ ai_html_generation_review_report_file }}"
  register: json_report

- name: Fail if JSON report not found
  fail:
    msg: "JSON review report not found at {{ ai_html_generation_review_report_file }}"
  when: not json_report.stat.exists

- name: Generate HTML report from JSON
  command: >
    {{ ai_html_generation_venv_dir }}/bin/python3
    {{ ansible_user_dir }}/render_html_from_json.py
    {{ ai_html_generation_review_report_file }}
    {{ ai_html_generation_html_report_file }}
    -v
  register: html_generation

- name: Display HTML generation result
  debug:
    msg: "{{ html_generation.stdout }}"
  when: html_generation.rc == 0

- name: Display HTML generation error
  debug:
    msg: "HTML generation failed: {{ html_generation.stderr }}"
  when: html_generation.rc != 0

- name: Verify HTML report was created
  stat:
    path: "{{ ai_html_generation_html_report_file }}"
  register: html_report

- name: Fail if HTML generation failed
  fail:
    msg: "HTML report generation failed"
  when: not html_report.stat.exists
