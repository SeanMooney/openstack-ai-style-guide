---
# Reusable task for executing Claude CLI commands
#
# Required variables:
#   - model_name: Model to use (e.g., "{{ context_model }}")
#   - prompt_text: Prompt string passed to Claude (may include @file references)
#   - output_file: Expected output file path (Claude is instructed to write here)
#   - command_name: Human-readable name (e.g., "context extraction")
#   - anthropic_auth_token: API authentication token
#   - anthropic_api_url: API base URL
# Optional variables:
#   - working_dir: Working directory for command execution (defaults to current)

- name: "Validate required environment variables for {{ command_name }}"
  fail:
    msg: "Required variable {{ item }} is not defined for Claude {{ command_name }}"
  when: vars[item] is not defined or vars[item] == ''
  loop:
    - anthropic_auth_token
    - anthropic_api_url

- name: "Build Claude {{ command_name }} command"
  set_fact:
    # NOTE: Tool permissions are intentionally broad for CI automation:
    # - Bash: Required for git CLI operations (log, diff, status) and CI commands
    # - Read/Grep/Glob: Required for code analysis and file discovery
    # - Write: Required for generating review reports and output files
    # - Edit: Allows Claude to suggest/apply fixes during review
    # This is appropriate for a trusted CI environment. For untrusted contexts,
    # restrict to read-only tools (Read, Grep, Glob) and manual review workflows.
    claude_command: >-
      {{ claude_binary }} --print "{{ prompt_text | replace('"', '\\"') }}"
      --model "{{ model_name }}"
      --output-format text
      --allowedTools "Bash,Read,Write,Edit,Grep,Glob"
      --permission-mode acceptEdits

- name: "Display Claude {{ command_name }} command"
  debug:
    msg: |
      Claude command (headless mode):
      {{ claude_command }}

      Working directory: {{ working_dir | default(ansible_user_dir) }}
      Expected output: {{ output_file }}

- name: "Run Claude for {{ command_name }} in headless mode (retry until output file exists)"
  shell:
    cmd: "{{ claude_command }} && test -f '{{ output_file }}'"
    chdir: "{{ working_dir | default(omit) }}"
  register: command_result
  environment:
    ANTHROPIC_AUTH_TOKEN: "{{ anthropic_auth_token }}"
    ANTHROPIC_BASE_URL: "{{ anthropic_api_url }}"
  failed_when: false
  retries: 3
  delay: 10
  # Stop retrying on permanent errors (auth failures, model not found)
  until: >
    command_result.rc == 0 or
    (command_result.stderr | default('') is search('authentication|invalid.*key|unauthorized')) or
    (command_result.stderr | default('') is search('model.*not.*found|unknown.*model|invalid.*model'))

- name: "Display retry summary for {{ command_name }}"
  debug:
    msg: >-
      {{ command_name | capitalize }} completed after {{ command_result.attempts | default(1) }}
      attempt(s). Status: {{ 'SUCCESS' if command_result.rc == 0 else 'FAILED' }}
  when: command_result.attempts | default(1) > 1

- name: "Analyze failure type for {{ command_name }}"
  set_fact:
    error_type: >-
      {%- if command_result.stderr | default('') is search('authentication|invalid.*key|unauthorized') -%}
        authentication
      {%- elif command_result.stderr | default('') is search('model.*not.*found|unknown.*model|invalid.*model') -%}
        model_not_found
      {%- elif command_result.stderr | default('') is search('503|overloaded|rate.*limit|too.*many.*requests') -%}
        transient
      {%- elif command_result.stderr | default('') is search('connection|timeout|network|unreachable') -%}
        connectivity
      {%- else -%}
        unknown
      {%- endif -%}
  when: command_result.rc != 0

- name: "Fail with specific guidance for {{ command_name }}"
  fail:
    msg: |
      Claude {{ command_name }} failed after {{ command_result.attempts | default(1) }} attempt(s).
      Return code: {{ command_result.rc }}
      Error type: {{ error_type | default('unknown') }}

      {% if error_type == 'authentication' %}
      ===========================================================
      AUTHENTICATION ERROR
      ===========================================================
      The API rejected the authentication token.

      Troubleshooting:
      - Verify ANTHROPIC_AUTH_TOKEN: {{ anthropic_auth_token }}
      - Check if token has expired or been revoked
      - Confirm LiteLLM proxy is accepting this token
      - Test API endpoint: curl {{ anthropic_api_url }}/health

      {% elif error_type == 'model_not_found' %}
      ===========================================================
      MODEL NOT FOUND ERROR
      ===========================================================
      The requested model "{{ model_name }}" is not available.

      Troubleshooting:
      - Verify model name spelling: {{ model_name }}
      - Check LiteLLM proxy configuration for available models
      - List available models: curl {{ anthropic_api_url }}/v1/models
      - Review LiteLLM proxy logs: kubectl logs -n zuul-system -l app=litellm

      {% elif error_type == 'transient' %}
      ===========================================================
      TRANSIENT ERROR (retried {{ command_result.attempts }} times)
      ===========================================================
      The service may be overloaded or rate limited.

      Troubleshooting:
      - Reduce concurrent Zuul jobs using this model
      - Check LiteLLM proxy capacity: kubectl top pod -n zuul-system
      - Review LiteLLM proxy logs for rate limit errors
      - Consider increasing job timeout or retry delays

      {% elif error_type == 'connectivity' %}
      ===========================================================
      CONNECTIVITY ERROR
      ===========================================================
      Cannot reach API endpoint: {{ anthropic_api_url }}

      Troubleshooting:
      - Verify network connectivity from build node
      - Check LiteLLM service status: kubectl get svc -n zuul-system litellm
      - Test endpoint reachability: curl -v {{ anthropic_api_url }}/health
      - Review network policies and firewall rules

      {% else %}
      ===========================================================
      UNKNOWN ERROR
      ===========================================================
      The error type could not be automatically determined.
      Review the stderr output below for clues.

      {% endif %}

      Command Output:
      -----------------------------------------------------------
      STDOUT:
      {{ command_result.stdout | default('(empty)') }}

      STDERR:
      {{ command_result.stderr | default('(empty)') }}
  when: command_result.rc != 0

- name: "Check {{ command_name }} result"
  include_tasks: check-claude-result.yaml
  vars:
    # command_result already set from shell command above
    # command_name, model_name, output_file passed through from parent
